<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>經緯度 ⇄ TWD97（DMS & Decimal）互轉器</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f1724; --muted:#94a3b8; --accent:#06b6d4; --ok:#86efac; --err:#fb7185; --text:#e6eef6;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family: "Noto Sans TC", "Microsoft JhengHei", system-ui, -apple-system, Arial; background:linear-gradient(180deg,#061021,#081427 40%); color:var(--text); padding:18px;}
  .wrap{max-width:960px;margin:0 auto}
  header{display:flex;gap:14px;align-items:center;justify-content:space-between}
  h1{font-size:20px;margin:6px 0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); padding:14px;border-radius:12px;margin-top:14px;}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:820px){.row{grid-template-columns:1fr}}
  input, select, button{font-size:15px}
  input[type="number"], input[type="text"], select{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04);
    background:#071423; color:var(--text);
  }
  .small{padding:8px 10px; width:100%;}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{padding:9px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#071423;color:var(--text);cursor:pointer}
  button.primary{background:linear-gradient(180deg,var(--accent),#0284a8); color:#021824; font-weight:700; border:none}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .out{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px}
  .note{margin-top:10px;color:var(--muted);font-size:13px}
  .status{margin-top:10px;font-size:13px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .small-btn{padding:6px 8px;font-size:13px;border-radius:8px}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>經緯度 ⇄ TWD97 互轉器</h1>
      <p class="lead">支援度分秒 (DMS) 與 十進位 (Decimal) 輸入，並可選 TM2 121 / 119（離線運算）。</p>
    </div>
    <div style="text-align:right">
      <button id="copyAll" class="small-btn ghost">複製結果</button>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <label>輸入模式</label>
        <div style="display:flex;gap:8px">
          <button id="btn-mode-dms" class="small-btn">度分秒 (DMS)</button>
          <button id="btn-mode-dec" class="small-btn">十進位 (Decimal)</button>
        </div>
      </div>
      <div>
        <label>投影帶（Zone）</label>
        <select id="zone" class="small">
          <option value="121" selected>TM2 / 121（本島）</option>
          <option value="119">TM2 / 119（澎湖）</option>
        </select>
      </div>
    </div>

    <!-- DMS -->
    <div id="block-dms" style="margin-top:12px">
      <label>緯度 ↓ (北緯為正)</label>
      <div class="grid-3">
        <input id="lat_deg" type="number" placeholder="度 (°) e.g. 25">
        <input id="lat_min" type="number" placeholder="分 (′) e.g. 2">
        <input id="lat_sec" type="number" step="0.001" placeholder='秒 (″) e.g. 2.27'>
      </div>

      <label style="margin-top:8px">經度 ↓ (東經為正)</label>
      <div class="grid-3">
        <input id="lon_deg" type="number" placeholder="度 (°) e.g. 121">
        <input id="lon_min" type="number" placeholder="分 (′) e.g. 33">
        <input id="lon_sec" type="number" step="0.001" placeholder='秒 (″) e.g. 52.08'>
      </div>
    </div>

    <!-- Decimal -->
    <div id="block-dec" style="margin-top:12px; display:none;">
      <div class="row">
        <div>
          <label>緯度（十進位，北緯為正）</label>
          <input id="lat_dec" type="number" step="0.000001" placeholder="例如 25.033964">
        </div>
        <div>
          <label>經度（十進位，東經為正）</label>
          <input id="lon_dec" type="number" step="0.000001" placeholder="例如 121.564468">
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="btn-convert-to-twd" class="primary">經緯度 → TWD97</button>
      <button id="btn-convert-to-latlon" class="primary">TWD97 → 經緯度</button>
      <button id="btn-fill-tpe" class="ghost">填入 Taipei 101 範例</button>
      <button id="btn-clear" class="ghost">清除所有欄位</button>
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

    <div class="row">
      <div>
        <label>TWD97 X（Easting, m）</label>
        <input id="out_x" class="mono" type="text" readonly placeholder="例如 306xxxx.x">
      </div>
      <div>
        <label>TWD97 Y（Northing, m）</label>
        <input id="out_y" class="mono" type="text" readonly placeholder="例如 276xxxx.x">
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <div>
        <label>十進位經緯度（同步輸出）</label>
        <input id="out_lat_dec" type="text" readonly class="mono">
      </div>
      <div>
        <label>度分秒（同步輸出）</label>
        <input id="out_lat_dms" type="text" readonly class="mono">
      </div>
    </div>

    <div class="note">提示：DMS 模式可只填度與秒（分留空），系統會自動處理。若要負緯度/負經度，請輸入負數。</div>
    <div id="status" class="status">狀態：待輸入</div>
  </div>

  <footer>
    Implemented with GRS80 (TWD97)、k₀=0.9999、False Easting = 250,000。適合在台灣使用。
  </footer>
</div>

<script>
/* ----- UI 互動 ----- */
const btnDMS = document.getElementById('btn-mode-dms');
const btnDEC = document.getElementById('btn-mode-dec');
const blockDMS = document.getElementById('block-dms');
const blockDEC = document.getElementById('block-dec');
const statusEl = document.getElementById('status');
const copyAllBtn = document.getElementById('copyAll');

btnDMS.onclick = () => { blockDMS.style.display='block'; blockDEC.style.display='none'; btnDMS.classList.add('ghost'); btnDEC.classList.remove('ghost'); status('切換到 DMS 模式'); };
btnDEC.onclick = () => { blockDMS.style.display='none'; blockDEC.style.display='block'; btnDEC.classList.add('ghost'); btnDMS.classList.remove('ghost'); status('切換到 十進位 模式'); };

function status(txt, ok=true){
  statusEl.innerHTML = '狀態：' + (ok ? `<span class="ok">${txt}</span>` : `<span class="err">${txt}</span>`);
}

/* helper DMS <-> Decimal */
function dmsToDecimal(d,m,s){
  d = Number(d||0); m = Number(m||0); s = Number(s||0);
  const sign = d < 0 ? -1 : 1;
  const deg = Math.abs(d) + (Math.abs(m)/60) + (Math.abs(s)/3600);
  return sign * deg;
}
function decimalToDMS(dec){
  const sign = dec < 0 ? -1 : 1;
  dec = Math.abs(dec);
  const deg = Math.floor(dec);
  const minFloat = (dec - deg) * 60;
  const min = Math.floor(minFloat);
  const sec = (minFloat - min) * 60;
  return {deg: deg * sign, min, sec};
}

/* ----- 投影與數學常數 (GRS80/TM2) ----- */
const a = 6378137.0;
const f = 1/298.257222101;
const e2 = 2*f - f*f;
const k0 = 0.9999;
const FE = 250000.0;
const FN = 0.0;

/* Meridional arc helper */
function meridionalArc(phi){
  const e4 = e2*e2, e6 = e4*e2;
  const A0 = 1 - e2/4 - 3*e4/64 - 5*e6/256;
  const A2 = 3/8*(e2 + e4/4 + 15*e6/128);
  const A4 = 15/256*(e4 + 3*e6/4);
  const A6 = 35*e6/3072;
  return a * (A0*phi - A2*Math.sin(2*phi) + A4*Math.sin(4*phi) - A6*Math.sin(6*phi));
}

/* 經緯度（度） -> TWD97 (x: Easting, y: Northing) */
function ll2twd97(latDeg, lonDeg, zone){
  const lon0 = (zone===119) ? 119 : 121;
  const lambda0 = lon0 * Math.PI / 180;

  const phi = latDeg * Math.PI / 180;
  const lambda = lonDeg * Math.PI / 180;
  const ep2 = e2 / (1 - e2);
  const sinp = Math.sin(phi), cosp = Math.cos(phi), tanp = Math.tan(phi);

  const N = a / Math.sqrt(1 - e2 * sinp*sinp);
  const T = tanp * tanp;
  const C = ep2 * cosp * cosp;
  const A = (lambda - lambda0) * cosp;
  const M = meridionalArc(phi);

  const x = FE + k0 * N * (A + (1 - T + C)*Math.pow(A,3)/6 + (5 - 18*T + T*T + 72*C - 58*ep2)*Math.pow(A,5)/120);
  const y = FN + k0 * ( M + N*tanp * ( Math.pow(A,2)/2 + (5 - T + 9*C + 4*C*C)*Math.pow(A,4)/24
                        + (61 - 58*T + T*T + 600*C - 330*ep2)*Math.pow(A,6)/720 ) );

  return {x, y};
}

/* TWD97 -> 經緯度（度） */
function twd972ll(x_in, y_in, zone){
  const lon0 = (zone===119) ? 119 : 121;
  const lambda0 = lon0 * Math.PI / 180;

  const x = x_in - FE;
  const y = y_in - FN;
  const M = y / k0;

  // series constants
  const e4 = e2*e2, e6 = e4*e2;
  const A0 = 1 - e2/4 - 3*e4/64 - 5*e6/256;
  const A2 = 3/8*(e2 + e4/4 + 15*e6/128);
  const A4 = 15/256*(e4 + 3*e6/4);
  const A6 = 35*e6/3072;
  const A = a*(A0);
  // Use inverse formula via footpoint latitude (mu -> fp)
  // Compute mu via series (Snyder)
  const mu = M / (a*(A0));
  // compute e1
  const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));
  const J1 = 3*e1/2 - 27*Math.pow(e1,3)/32;
  const J2 = 21*Math.pow(e1,2)/16 - 55*Math.pow(e1,4)/32;
  const J3 = 151*Math.pow(e1,3)/96;
  const J4 = 1097*Math.pow(e1,4)/512;
  const fp = mu + J1*Math.sin(2*mu) + J2*Math.sin(4*mu) + J3*Math.sin(6*mu) + J4*Math.sin(8*mu);

  const sinfp = Math.sin(fp), cosfp = Math.cos(fp), tanfp = Math.tan(fp);
  const ep2 = e2 / (1 - e2);
  const C1 = ep2 * cosfp * cosfp;
  const T1 = tanfp * tanfp;
  const N1 = a / Math.sqrt(1 - e2 * sinfp*sinfp);
  const R1 = N1 * (1 - e2) / (1 - e2 * sinfp*sinfp);
  const D = x / (N1 * k0);

  // latitude (rad)
  let lat = fp - (N1 * tanfp / R1) * ( D*D/2 - (5 + 3*T1 + 10*C1 - 4*C1*C1 - 9*ep2) * Math.pow(D,4)/24
      + (61 + 90*T1 + 298*C1 + 45*T1*T1 - 252*ep2 - 3*C1*C1) * Math.pow(D,6)/720 );

  // longitude (rad)
  let lon = lambda0 + ( D - (1 + 2*T1 + C1) * Math.pow(D,3)/6 + (5 - 2*C1 + 28*T1 - 3*C1*C1 + 8*ep2 + 24*T1*T1) * Math.pow(D,5)/120 ) / cosfp;

  // convert to degrees
  return { lat: lat * 180 / Math.PI, lon: lon * 180 / Math.PI };
}

/* ----- 事件： 經緯度 -> TWD97 ----- */
document.getElementById('btn-convert-to-twd').onclick = () => {
  const zone = Number(document.getElementById('zone').value);

  // try decimal fields first
  let latDec = Number(document.getElementById('lat_dec').value);
  let lonDec = Number(document.getElementById('lon_dec').value);

  // if decimal not provided, read DMS
  if (!latDec && !lonDec && blockDMS.style.display !== 'none') {
    const ld = document.getElementById('lat_deg').value;
    const lm = document.getElementById('lat_min').value;
    const ls = document.getElementById('lat_sec').value;
    const lod = document.getElementById('lon_deg').value;
    const lom = document.getElementById('lon_min').value;
    const los = document.getElementById('lon_sec').value;

    if(ld === '' || lod === '') {
      status('請至少填入度數欄位（緯度與經度）', false); return;
    }
    latDec = dmsToDecimal(ld, lm, ls);
    lonDec = dmsToDecimal(lod, lom, los);
  } else if (blockDEC.style.display !== 'none') {
    if (isNaN(latDec) || isNaN(lonDec)) { status('請輸入有效的十進位經緯度', false); return; }
  } else {
    // If decimal inputs empty, but DMS hidden, try DMS anyway
    if (isNaN(latDec) || isNaN(lonDec)) { status('請輸入經緯度（DMS 或 十進位）', false); return; }
  }

  // basic range check (台灣附近範圍寬鬆)
  if (!(latDec > -90 && latDec < 90 && lonDec > -180 && lonDec < 180)) {
    status('緯度/經度數值異常', false); return;
  }

  const res = ll2twd97(latDec, lonDec, zone);
  document.getElementById('out_x').value = res.x.toFixed(3);
  document.getElementById('out_y').value = res.y.toFixed(3);

  // update output decimal and DMS
  document.getElementById('out_lat_dec').value = `Lat ${latDec.toFixed(6)}, Lon ${lonDec.toFixed(6)}`;
  const lat_dms = decimalToDMS(latDec), lon_dms = decimalToDMS(lonDec);
  document.getElementById('out_lat_dms').value = `Lat ${lat_dms.deg}°${lat_dms.min}ʼ${lat_dms.sec.toFixed(3)}″, Lon ${lon_dms.deg}°${lon_dms.min}ʼ${lon_dms.sec.toFixed(3)}″`;

  status('轉換完成 ✅');
};

/* ----- 事件： TWD97 -> 經緯度 ----- */
document.getElementById('btn-convert-to-latlon').onclick = () => {
  const zone = Number(document.getElementById('zone').value);
  const x = Number(document.getElementById('out_x').value) || Number(document.getElementById('twd_x_input')?.value || 0);
  const y = Number(document.getElementById('out_y').value) || Number(document.getElementById('twd_y_input')?.value || 0);
  // allow user to input directly to out_x/out_y before pressing this button
  if (!x || !y) {
    // try reading from labeled TWD97 inputs (if they exist)
    // but here we assume out_x/out_y are where user put TWD97 to convert back
    status('請在「TWD97 X/Y」欄位輸入要轉換的座標', false); return;
  }
  if (isNaN(x) || isNaN(y)) { status('TWD97 座標格式錯誤', false); return; }

  const ll = twd972ll(x, y, zone);
  document.getElementById('out_lat_dec').value = `Lat ${ll.lat.toFixed(6)}, Lon ${ll.lon.toFixed(6)}`;
  const lat_dms = decimalToDMS(ll.lat), lon_dms = decimalToDMS(ll.lon);
  document.getElementById('out_lat_dms').value = `Lat ${lat_dms.deg}°${lat_dms.min}ʼ${lat_dms.sec.toFixed(3)}″, Lon ${lon_dms.deg}°${lon_dms.min}ʼ${lon_dms.sec.toFixed(3)}″`;

  status('反向轉換完成 ✅');
};

/* Taipei 101 範例 */
document.getElementById('btn-fill-tpe').onclick = () => {
  // fill both DMS and decimal
  document.getElementById('lat_deg').value = 25;
  document.getElementById('lat_min').value = 2;
  document.getElementById('lat_sec').value = 2.27;
  document.getElementById('lon_deg').value = 121;
  document.getElementById('lon_min').value = 33;
  document.getElementById('lon_sec').value = 52.08;
  document.getElementById('lat_dec').value = 25.033964;
  document.getElementById('lon_dec').value = 121.564468;
  status('已填入 Taipei 101 範例');
};

/* Clear */
document.getElementById('btn-clear').onclick = () => {
  ['lat_deg','lat_min','lat_sec','lon_deg','lon_min','lon_sec','lat_dec','lon_dec','out_x','out_y','out_lat_dec','out_lat_dms'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.value = '';
  });
  status('欄位已清空');
};

/* Copy all results button */
copyAllBtn.onclick = async () => {
  const txt = `TWD97 X: ${document.getElementById('out_x').value}\nTWD97 Y: ${document.getElementById('out_y').value}\n${document.getElementById('out_lat_dec').value}\n${document.getElementById('out_lat_dms').value}`;
  try {
    await navigator.clipboard.writeText(txt);
    status('已複製結果到剪貼簿 ✅');
  } catch (e) {
    status('複製失敗，請手動選取複製', false);
  }
};

/* Auto-sync: 當十進位輸入改變，同步到 DMS 輸出欄（但不覆寫使用者的 DMS 輸入） */
document.getElementById('lat_dec').addEventListener('input', (e)=>{
  const v = Number(e.target.value);
  if (!isNaN(v)) {
    const d = decimalToDMS(v);
    // do not overwrite user DMS inputs, just show in output
    document.getElementById('out_lat_dms').value = `Lat ${d.deg}°${d.min}ʼ${d.sec.toFixed(3)}″`;
  }
});
document.getElementById('lon_dec').addEventListener('input', (e)=>{
  const v = Number(e.target.value);
  if (!isNaN(v)) {
    const d = decimalToDMS(v);
    document.getElementById('out_lat_dec').value = `Lon ${v.toFixed(6)}`;
  }
});

/* Initialize */
status('就緒，請輸入座標並按「經緯度 → TWD97」或「TWD97 → 經緯度」');
</script>
</body>
</html>
