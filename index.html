<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>經緯度 ⇄ TWD97（TM2/121 台灣 & TM2/119 澎湖）互轉（自動判 N/S）</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root{
    --bg:#061225; --panel:#0d1a2a; --muted:#9fb0c6; --accent:#06b6d4;
    --ok:#86efac; --err:#fb7185; --text:#e6eef6; --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,Arial;background:linear-gradient(180deg,#041020,#061225);color:var(--text)}
  .container{max-width:1200px;margin:14px auto;padding:12px;display:flex;gap:12px;align-items:flex-start}
  @media (max-width:1000px){ .container{flex-direction:column} }
  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid var(--glass);padding:14px;border-radius:12px}
  .left{width:420px}
  .right{flex:1;min-height:640px}
  @media (max-width:1000px){ .left,.right{width:100%} .right{min-height:420px} }
  h1{margin:0 0 6px;font-size:18px}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  label{display:block;color:var(--muted);font-size:13px;margin:8px 0 6px}
  input, select, button{font-size:14px}
  input[type="text"], input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#071423;color:var(--text)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .small{padding:8px 10px;border-radius:8px;background:#071423;color:var(--text);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .primary{background:linear-gradient(180deg,var(--accent),#0284a8);color:#012226;border:none;font-weight:700}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  #map{width:100%;height:calc(100vh - 80px);border-radius:10px;border:1px solid var(--glass)}
  @media(max-width:1000px){ #map{height:360px} }
  .small-label{font-size:12px;color:var(--muted)}
  .sep{height:1px;background:rgba(255,255,255,0.03);margin:12px 0;border-radius:3px}
  .status{margin-top:8px;font-size:13px;color:var(--muted)}
  .result-box{margin-top:8px;display:grid;gap:8px}
  .zone-label{font-weight:700;font-size:13px;color:var(--accent)}
  .footer{margin-top:10px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>

<div class="container">
  <div class="panel left">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
      <div>
        <h1>經緯度 ⇄ TWD97（TM2/121 台灣 & TM2/119 澎湖）</h1>
        <p class="lead">DMS / Decimal 分離輸入 • 自動判斷 N/S 與 E/W • 兩帶同時計算 • 地圖互動</p>
      </div>
      <div style="text-align:right">
        <button id="btn_copy_all" class="small">複製全部結果</button>
      </div>
    </div>

    <!-- DMS -->
    <label>度分秒（DMS）輸入 — 緯度（度可為負數表示南緯；正數表示北緯）</label>
    <div class="grid3">
      <input id="dms_lat_deg" type="number" placeholder="度 (°) 例如 25 或 -25">
      <input id="dms_lat_min" type="number" placeholder="分 (′) 例如 2">
      <input id="dms_lat_sec" type="number" step="0.001" placeholder='秒 (″) 例如 2.27'>
    </div>
    <div class="small-label">提示：若你輸入負數度（-25），系統會自動視為南緯（S）。</div>

    <label style="margin-top:8px">度分秒（DMS）輸入 — 經度（度可為負數表示西經）</label>
    <div class="grid3">
      <input id="dms_lon_deg" type="number" placeholder="度 (°) 例如 121 或 -121">
      <input id="dms_lon_min" type="number" placeholder="分 (′) 例如 33">
      <input id="dms_lon_sec" type="number" step="0.001" placeholder='秒 (″) 例如 52.08'>
    </div>
    <div class="actions">
      <button id="btn_dms_to_twd" class="small primary">用 DMS 轉兩帶 TWD97</button>
      <button id="btn_clear_dms" class="small">清除 DMS</button>
    </div>

    <div class="sep"></div>

    <!-- Decimal -->
    <label>十進位（Decimal）輸入（正數自動為 N/E，負數自動為 S/W）</label>
    <div class="grid2">
      <input id="dec_lat" type="number" step="0.000001" placeholder="緯度，例如 25.033964 或 -25.033964">
      <input id="dec_lon" type="number" step="0.000001" placeholder="經度，例如 121.564468 或 -121.564468">
    </div>
    <div class="small-label">提示：正數→北/東；負數→南/西。點地圖會回填十進位。</div>

    <div class="actions">
      <button id="btn_dec_to_twd" class="small primary">用 Decimal 轉兩帶 TWD97</button>
      <button id="btn_clear_dec" class="small">清除 Decimal</button>
      <button id="btn_geolocate" class="small">定位（裝置）</button>
    </div>

    <div class="sep"></div>

    <!-- TWD97 – 121 -->
    <label class="zone-label">TM2 / 121 — 台灣本島</label>
    <div class="grid2">
      <input id="x_121" type="number" placeholder="X (TM2/121)">
      <input id="y_121" type="number" placeholder="Y (TM2/121)">
    </div>
    <div class="actions" style="margin-top:8px">
      <button id="btn_121_to_lat" class="small primary">121 → 經緯度</button>
      <button id="btn_clear_121" class="small">清除 121</button>
    </div>

    <!-- TWD97 – 119 -->
    <label class="zone-label" style="margin-top:10px">TM2 / 119 — 澎湖群島</label>
    <div class="grid2">
      <input id="x_119" type="number" placeholder="X (TM2/119)">
      <input id="y_119" type="number" placeholder="Y (TM2/119)">
    </div>
    <div class="actions" style="margin-top:8px">
      <button id="btn_119_to_lat" class="small primary">119 → 經緯度</button>
      <button id="btn_clear_119" class="small">清除 119</button>
    </div>

    <div class="sep"></div>

    <div class="result-box">
      <label>輸出（十進位經緯）</label>
      <input id="out_decimal" class="mono" readonly>

      <label style="margin-top:6px">輸出（度分秒 DMS — 自動附加 N/S、E/W）</label>
      <input id="out_dms" class="mono" readonly>

      <label style="margin-top:6px">兩帶 TWD97 結果</label>
      <input id="out_121" class="mono" readonly placeholder="TM2/121 結果（台灣本島）">
      <input id="out_119" class="mono" readonly placeholder="TM2/119 結果（澎湖）">
    </div>

    <div class="actions" style="margin-top:10px">
      <button id="btn_example" class="small">範例：Taipei 101</button>
      <button id="btn_copy_result" class="small">複製顯示結果</button>
      <button id="btn_clear_all" class="small">全部清除</button>
    </div>

    <div id="status" class="status">狀態：就緒</div>
    <div class="footer">GRS80 / k₀=0.9999 / FE=250000 / FN=0 — 點地圖可取點並標記（會自動顯示 TM2/121 台灣、本島與 TM2/119 澎湖）</div>
  </div>

  <div class="panel right">
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ---------- DMS <-> Decimal and formatting (with hemisphere letters) ---------- */
function dmsToDecimalParts(deg, min, sec){
  deg = Number(deg) || 0; min = Number(min) || 0; sec = Number(sec) || 0;
  const sign = deg < 0 ? -1 : 1;
  const val = Math.abs(deg) + Math.abs(min)/60 + Math.abs(sec)/3600;
  return sign < 0 ? -val : val;
}
function decimalToDMSWithHemisphere(value, type){ // type: 'lat' or 'lon'
  if(isNaN(value)) return '';
  const hemi = (type === 'lat') ? (value >= 0 ? 'N' : 'S') : (value >= 0 ? 'E' : 'W');
  const absv = Math.abs(value);
  const d = Math.floor(absv);
  const minFloat = (absv - d) * 60;
  const m = Math.floor(minFloat);
  const s = (minFloat - m) * 60;
  return `${d}°${m}′${s.toFixed(3)}″ ${hemi}`;
}

/* ---------- Geodetic <-> TWD97 (GRS80 / TM2) ---------- */
const a = 6378137.0;
const f = 1/298.257222101;
const e2 = 2*f - f*f;
const k0 = 0.9999;
const FE = 250000.0;
const FN = 0.0;
function rad(d){ return d * Math.PI / 180; }
function meridionalArc(phi){
  const e4 = e2*e2, e6 = e4*e2;
  const A0 = 1 - e2/4 - 3*e4/64 - 5*e6/256;
  const A2 = 3/8*(e2 + e4/4 + 15*e6/128);
  const A4 = 15/256*(e4 + 3*e6/4);
  const A6 = 35*e6/3072;
  return a * (A0*phi - A2*Math.sin(2*phi) + A4*Math.sin(4*phi) - A6*Math.sin(6*phi));
}
function ll2twd97(latDeg, lonDeg, zone){
  const lon0 = (zone==119)?119:121;
  const lambda0 = rad(lon0);
  const phi = rad(latDeg), lambda = rad(lonDeg);
  const ep2 = e2 / (1 - e2);
  const sinp = Math.sin(phi), cosp = Math.cos(phi), tanp = Math.tan(phi);
  const N = a / Math.sqrt(1 - e2 * sinp*sinp);
  const T = tanp * tanp;
  const C = ep2 * cosp * cosp;
  const A = (lambda - lambda0) * cosp;
  const M = meridionalArc(phi);
  const x = FE + k0 * N * (A + (1 - T + C)*Math.pow(A,3)/6 + (5 - 18*T + T*T + 72*C - 58*ep2)*Math.pow(A,5)/120);
  const y = FN + k0 * ( M + N*tanp * ( Math.pow(A,2)/2 + (5 - T + 9*C + 4*C*C)*Math.pow(A,4)/24
                      + (61 - 58*T + T*T + 600*C - 330*ep2)*Math.pow(A,6)/720 ) );
  return {x, y};
}
function twd972ll(x_in, y_in, zone){
  const lon0 = (zone==119)?119:121;
  const lambda0 = rad(lon0);
  const x = x_in - FE;
  const y = y_in - FN;
  const M = y / k0;
  const e4 = e2*e2, e6 = e4*e2;
  const A0 = 1 - e2/4 - 3*e4/64 - 5*e6/256;
  const mu = M / (a*(A0));
  const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));
  const J1 = 3*e1/2 - 27*Math.pow(e1,3)/32;
  const J2 = 21*Math.pow(e1,2)/16 - 55*Math.pow(e1,4)/32;
  const J3 = 151*Math.pow(e1,3)/96;
  const J4 = 1097*Math.pow(e1,4)/512;
  const fp = mu + J1*Math.sin(2*mu) + J2*Math.sin(4*mu) + J3*Math.sin(6*mu) + J4*Math.sin(8*mu);
  const sinfp = Math.sin(fp), cosfp = Math.cos(fp), tanfp = Math.tan(fp);
  const ep2 = e2 / (1 - e2);
  const C1 = ep2 * cosfp * cosfp;
  const T1 = tanfp * tanfp;
  const N1 = a / Math.sqrt(1 - e2 * sinfp*sinfp);
  const R1 = N1 * (1 - e2) / (1 - e2 * sinfp*sinfp);
  const D = x / (N1 * k0);
  const lat = fp - (N1 * tanfp / R1) * ( D*D/2 - (5 + 3*T1 + 10*C1 - 4*C1*C1 - 9*ep2) * Math.pow(D,4)/24
      + (61 + 90*T1 + 298*C1 + 45*T1*T1 - 252*ep2 - 3*C1*C1) * Math.pow(D,6)/720 );
  const lon = lambda0 + ( D - (1 + 2*T1 + C1) * Math.pow(D,3)/6 + (5 - 2*C1 + 28*T1 - 3*C1*C1 + 8*ep2 + 24*T1*T1) * Math.pow(D,5)/120 ) / cosfp;
  return { lat: lat * 180 / Math.PI, lon: lon * 180 / Math.PI };
}

/* ---------------- Leaflet map init ---------------- */
const map = L.map('map', { zoomControl:true }).setView([23.7,121],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
let marker = null;
function placeMarker(lat, lon, html){
  if(marker) marker.remove();
  marker = L.marker([lat,lon], {draggable:true}).addTo(map);
  if(html) marker.bindPopup(html).openPopup();
  marker.on('dragend', e => {
    const p = e.target.getLatLng();
    document.getElementById('dec_lat').value = p.lat.toFixed(6);
    document.getElementById('dec_lon').value = p.lng.toFixed(6);
    computeBothAndShow(p.lat, p.lng);
  });
  map.panTo([lat,lon], {animate:true});
}

/* ---------------- UI helpers ---------------- */
function setStatus(txt, ok=true){
  const s = document.getElementById('status'); s.textContent = '狀態：' + txt; s.style.color = ok ? 'lightgreen' : '#ffb3b3';
}
setStatus('就緒');

/* --------------- Map click fills decimal --------------- */
map.on('click', e=>{
  const lat = e.latlng.lat, lon = e.latlng.lng;
  document.getElementById('dec_lat').value = lat.toFixed(6);
  document.getElementById('dec_lon').value = lon.toFixed(6);
  // clear DMS fields to avoid confusion
  ['dms_lat_deg','dms_lat_min','dms_lat_sec','dms_lon_deg','dms_lon_min','dms_lon_sec'].forEach(id=>document.getElementById(id).value='');
  computeBothAndShow(lat, lon);
});

/* --------------- DMS -> Decimal -> both bands --------------- */
document.getElementById('btn_dms_to_twd').addEventListener('click', ()=>{
  const degLat = document.getElementById('dms_lat_deg').value;
  const minLat = document.getElementById('dms_lat_min').value;
  const secLat = document.getElementById('dms_lat_sec').value;
  const degLon = document.getElementById('dms_lon_deg').value;
  const minLon = document.getElementById('dms_lon_min').value;
  const secLon = document.getElementById('dms_lon_sec').value;

  if(degLat==='' || degLon===''){ setStatus('請至少填入度數欄位（緯/經）', false); return; }
  const lat = dmsToDecimalParts(degLat, minLat, secLat);
  const lon = dmsToDecimalParts(degLon, minLon, secLon);

  document.getElementById('dec_lat').value = lat.toFixed(6);
  document.getElementById('dec_lon').value = lon.toFixed(6);
  computeBothAndShow(lat, lon);
});

/* --------------- Decimal -> both bands --------------- */
document.getElementById('btn_dec_to_twd').addEventListener('click', runDecimalToBoth);
function runDecimalToBoth(){
  const lat = parseFloat(document.getElementById('dec_lat').value);
  const lon = parseFloat(document.getElementById('dec_lon').value);
  if(isNaN(lat) || isNaN(lon)){ setStatus('請輸入有效的十進位經緯度', false); return; }
  // also populate DMS inputs for clarity (deg may be negative -> indicates S/W)
  const latD = Math.trunc(lat); const latMin = Math.trunc(Math.abs((lat - latD) * 60)); const latSec = Math.abs(((lat - latD) * 60 - latMin) * 60);
  const lonD = Math.trunc(lon); const lonMin = Math.trunc(Math.abs((lon - lonD) * 60)); const lonSec = Math.abs(((lon - lonD) * 60 - lonMin) * 60);
  document.getElementById('dms_lat_deg').value = latD; document.getElementById('dms_lat_min').value = latMin; document.getElementById('dms_lat_sec').value = latSec.toFixed(3);
  document.getElementById('dms_lon_deg').value = lonD; document.getElementById('dms_lon_min').value = lonMin; document.getElementById('dms_lon_sec').value = lonSec.toFixed(3);
  computeBothAndShow(lat, lon);
}

/* --------------- compute both zones, populate outputs --------------- */
function computeBothAndShow(lat, lon){
  if(!(lat>-90 && lat<90 && lon>-180 && lon<180)){ setStatus('輸入緯經不在合理範圍', false); }
  const r121 = ll2twd97(lat, lon, 121);
  const r119 = ll2twd97(lat, lon, 119);

  document.getElementById('x_121').value = r121.x.toFixed(3);
  document.getElementById('y_121').value = r121.y.toFixed(3);
  document.getElementById('x_119').value = r119.x.toFixed(3);
  document.getElementById('y_119').value = r119.y.toFixed(3);

  document.getElementById('out_decimal').value = `Lat ${lat.toFixed(6)}, Lon ${lon.toFixed(6)}`;
  document.getElementById('out_dms').value = `Lat ${decimalToDMSWithHemisphere(lat,'lat')}, Lon ${decimalToDMSWithHemisphere(lon,'lon')}`;
  document.getElementById('out_121').value = `TM2/121（台灣本島） → X:${r121.x.toFixed(3)} Y:${r121.y.toFixed(3)}`;
  document.getElementById('out_119').value = `TM2/119（澎湖） → X:${r119.x.toFixed(3)} Y:${r119.y.toFixed(3)}`;

  const popup = `<b>位置</b><br>Lat ${lat.toFixed(6)} (${decimalToDMSWithHemisphere(lat,'lat')})<br>Lon ${lon.toFixed(6)} (${decimalToDMSWithHemisphere(lon,'lon')})<br><br>
                 <b>TM2/121（台灣本島）</b><br>X ${r121.x.toFixed(3)}<br>Y ${r121.y.toFixed(3)}<br><br>
                 <b>TM2/119（澎湖）</b><br>X ${r119.x.toFixed(3)}<br>Y ${r119.y.toFixed(3)}`;
  placeMarker(lat, lon, popup);
  setStatus('已計算並在地圖標記（顯示 TM2/121 台灣本島 與 TM2/119 澎湖）', true);
}

/* --------------- reverse: 121 -> latlon --------------- */
document.getElementById('btn_121_to_lat').addEventListener('click', ()=>{
  const x = parseFloat(document.getElementById('x_121').value);
  const y = parseFloat(document.getElementById('y_121').value);
  if(isNaN(x) || isNaN(y)){ setStatus('請輸入 TM2/121 的 X 與 Y', false); return; }
  try{
    const ll = twd972ll(x,y,121);
    document.getElementById('dec_lat').value = ll.lat.toFixed(6);
    document.getElementById('dec_lon').value = ll.lon.toFixed(6);
    computeBothAndShow(ll.lat, ll.lon);
    setStatus('由 TM2/121 反算完成並標記', true);
  }catch(e){ setStatus('121 反算失敗', false); }
});

/* --------------- reverse: 119 -> latlon --------------- */
document.getElementById('btn_119_to_lat').addEventListener('click', ()=>{
  const x = parseFloat(document.getElementById('x_119').value);
  const y = parseFloat(document.getElementById('y_119').value);
  if(isNaN(x) || isNaN(y)){ setStatus('請輸入 TM2/119 的 X 與 Y', false); return; }
  try{
    const ll = twd972ll(x,y,119);
    document.getElementById('dec_lat').value = ll.lat.toFixed(6);
    document.getElementById('dec_lon').value = ll.lon.toFixed(6);
    computeBothAndShow(ll.lat, ll.lon);
    setStatus('由 TM2/119 反算完成並標記', true);
  }catch(e){ setStatus('119 反算失敗', false); }
});

/* --------------- clears, example, copy, locate --------------- */
document.getElementById('btn_clear_dms').addEventListener('click', ()=>{ ['dms_lat_deg','dms_lat_min','dms_lat_sec','dms_lon_deg','dms_lon_min','dms_lon_sec'].forEach(id=>document.getElementById(id).value=''); setStatus('DMS 已清除'); });
document.getElementById('btn_clear_dec').addEventListener('click', ()=>{ document.getElementById('dec_lat').value=''; document.getElementById('dec_lon').value=''; setStatus('Decimal 已清除'); });
document.getElementById('btn_clear_121').addEventListener('click', ()=>{ document.getElementById('x_121').value=''; document.getElementById('y_121').value=''; setStatus('121 已清除'); });
document.getElementById('btn_clear_119').addEventListener('click', ()=>{ document.getElementById('x_119').value=''; document.getElementById('y_119').value=''; setStatus('119 已清除'); });
document.getElementById('btn_clear_all').addEventListener('click', ()=>{ document.querySelectorAll('input').forEach(inp=>{ if(inp.type!=='checkbox') inp.value=''; else inp.checked=false; }); if(marker) marker.remove(); setStatus('全部已清除'); });

document.getElementById('btn_example').addEventListener('click', ()=>{
  // Taipei 101
  document.getElementById('dms_lat_deg').value='25'; document.getElementById('dms_lat_min').value='2'; document.getElementById('dms_lat_sec').value='2.27';
  document.getElementById('dms_lon_deg').value='121'; document.getElementById('dms_lon_min').value='33'; document.getElementById('dms_lon_sec').value='52.08';
  document.getElementById('dec_lat').value=''; document.getElementById('dec_lon').value='';
  setStatus('已填入 Taipei 101（按 DMS 轉兩帶）');
});

document.getElementById('btn_copy_result').addEventListener('click', async ()=>{
  const txt = `Decimal: ${document.getElementById('out_decimal').value}\nDMS: ${document.getElementById('out_dms').value}\nTM2/121: ${document.getElementById('out_121').value}\nTM2/119: ${document.getElementById('out_119').value}`;
  try{ await navigator.clipboard.writeText(txt); setStatus('顯示結果已複製到剪貼簿 ✅'); }catch(e){ setStatus('複製失敗，請手動複製', false); }
});
document.getElementById('btn_copy_all').addEventListener('click', ()=> document.getElementById('btn_copy_result').click());

document.getElementById('btn_geolocate').addEventListener('click', ()=>{
  if(!navigator.geolocation){ setStatus('裝置不支援定位', false); return; }
  setStatus('正在定位…');
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    document.getElementById('dec_lat').value = lat.toFixed(6);
    document.getElementById('dec_lon').value = lon.toFixed(6);
    computeBothAndShow(lat, lon);
  }, err=> setStatus('定位失敗：'+(err.message||err.code), false), {enableHighAccuracy:true, timeout:10000});
});

/* init status */
setStatus('就緒：輸入 DMS 或 Decimal 或點地圖。系統會自動判北/南（N/S）與東/西（E/W），並同時計算 TM2/121（台灣本島）與 TM2/119（澎湖）。');
</script>

</body>
</html>