<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DMS ➜ TWD97（TM2）轉換器</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#22c55e; --warn:#f59e0b; --text:#e5e7eb; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", Arial;
      background: radial-gradient(1200px 600px at 80% -20%, #1f2937 0%, #0b1220 50%, #070b14 100%), var(--bg);
      color: var(--text);
    }
    header { padding: 24px 20px 8px; text-align: center; }
    h1 { margin: 0 0 8px; font-size: 28px; letter-spacing: .5px; }
    p.lead { margin: 0; color: var(--muted); }
    .wrap { max-width: 880px; margin: 24px auto 80px; padding: 0 16px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(148,163,184,.2); border-radius: 14px; padding: 18px; box-shadow: 0 0 0 1px rgba(255,255,255,.02) inset;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 820px){ .row { grid-template-columns: 1fr; } }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; letter-spacing:.3px; }
    input, select {
      width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid rgba(148,163,184,.25);
      background: #0b1220; color: var(--text); outline: none; font-size: 15px;
    }
    input::placeholder { color: #64748b; }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button {
      border: 1px solid rgba(148,163,184,.25); background: #0b1220; color: var(--text);
      padding: 10px 14px; border-radius: 10px; cursor: pointer; font-size: 15px;
    }
    button.primary { background: linear-gradient(180deg, #22c55e, #16a34a); border: none; color:#052e13; font-weight:700; }
    button.warn { background: linear-gradient(180deg, #f59e0b, #d97706); border:none; color:#1f1302; font-weight:700; }
    .out {
      margin-top: 16px; display:grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .hint { margin-top: 10px; color: var(--muted); font-size: 13px; }
    .kbd {
      display:inline-block; padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(148,163,184,.3);
      background:#0b1220; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; color: #cbd5e1;
    }
    .note { margin-top: 16px; font-size: 13px; color: #cbd5e1; }
    .ok { color: #86efac; }
    .err { color: #fca5a5; }
    footer { text-align:center; color: var(--muted); padding: 28px 12px 48px; font-size: 12px; }
  </style>
</head>
<body>
<header>
  <h1>經緯度（DMS/十進位） ➜ TWD97 / TM2 座標轉換</h1>
  <p class="lead">GRS80 橢球、k₀=0.9999、False Easting = 250,000；支援 TM2 / 121 與 TM2 / 119</p>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <label>輸入模式</label>
        <div class="actions">
          <button id="mode-dms" class="warn">度 分 秒（DMS）</button>
          <button id="mode-dec">十進位（Decimal）</button>
        </div>
      </div>
      <div>
        <label>投影帶（Zone）</label>
        <select id="zone">
          <option value="121" selected>TWD97 / TM2 121（台灣本島）</option>
          <option value="119">TWD97 / TM2 119（澎湖）</option>
        </select>
      </div>
    </div>

    <div id="dms-block" style="margin-top:16px;">
      <div class="row">
        <div>
          <label>緯度 Latitude（N，北緯）</label>
          <div class="grid-3">
            <input id="lat-d" type="number" placeholder="度（°）例如 25" />
            <input id="lat-m" type="number" placeholder="分（′）0–59" />
            <input id="lat-s" type="number" step="0.001" placeholder="秒（″）0–59.999" />
          </div>
        </div>
        <div>
          <label>經度 Longitude（E，東經）</label>
          <div class="grid-3">
            <input id="lon-d" type="number" placeholder="度（°）例如 121" />
            <input id="lon-m" type="number" placeholder="分（′）0–59" />
            <input id="lon-s" type="number" step="0.001" placeholder="秒（″）0–59.999" />
          </div>
        </div>
      </div>
    </div>

    <div id="dec-block" style="margin-top:16px; display:none;">
      <div class="row">
        <div>
          <label>緯度（十進位，北緯為正）</label>
          <input id="lat-dec" type="number" step="0.000001" placeholder="例如 25.033964" />
        </div>
        <div>
          <label>經度（十進位，東經為正）</label>
          <input id="lon-dec" type="number" step="0.000001" placeholder="例如 121.564468" />
        </div>
      </div>
    </div>

    <div class="actions" style="margin-top:16px;">
      <button class="primary" id="btn-run">轉換 ➜ TWD97</button>
      <button id="btn-fill-tpe101">帶入 Taipei 101 範例</button>
      <button id="btn-clear">清除</button>
    </div>

    <div class="out" style="margin-top:14px;">
      <div>
        <label>東向 X（Easting, m）</label>
        <input id="out-x" class="mono" type="text" readonly />
      </div>
      <div>
        <label>北向 Y（Northing, m）</label>
        <input id="out-y" class="mono" type="text" readonly />
      </div>
    </div>

    <div class="hint">
      小技巧：鍵盤 <span class="kbd">Tab</span> 快速切欄位；若輸入 DMS，可只填整數度與小數秒（分留空也行，我幫你算）。
    </div>
    <div id="msg" class="note">狀態：<span class="ok">待命中，來轉一波～</span></div>
  </div>

  <footer>
    TWD97 = Taiwan Datum 1997（GRS80）；TM2/121 與 TM2/119 均採 k₀=0.9999、FE=250,000、FN=0。<br/>
    WGS84 與 TWD97 在台灣本島差距 ≲ 1 m，多數情境可直接視為相同。
  </footer>
</div>

<script>
/** ======= 數學與常數（GRS80 + TM2） ======= */
const a = 6378137.0;                 // GRS80 semi-major axis
const f = 1 / 298.257222101;         // GRS80 flattening
const e2 = 2*f - f*f;                // first eccentricity squared
const e4 = e2*e2, e6 = e4*e2;
const k0 = 0.9999;
const FE = 250000.0, FN = 0.0;

function rad(d){ return d * Math.PI / 180; }
function dmsToDecimal(d, m, s) {
  d = parseFloat(d || 0); m = parseFloat(m || 0); s = parseFloat(s || 0);
  const sign = d < 0 ? -1 : 1;
  const deg = Math.abs(d) + (Math.abs(m)/60) + (Math.abs(s)/3600);
  return sign * deg;
}

/** Meridional Arc（弧長） */
function meridionalArc(phi){
  const A0 = 1 - e2/4 - 3*e4/64 - 5*e6/256;
  const A2 = 3/8*(e2 + e4/4 + 15*e6/128);
  const A4 = 15/256*(e4 + 3*e6/4);
  const A6 = 35*e6/3072;
  return a * (A0*phi - A2*Math.sin(2*phi) + A4*Math.sin(4*phi) - A6*Math.sin(6*phi));
}

/** 核心：經緯度 ➜ TM2（TWD97） */
function ll2twd97(latDeg, lonDeg, zone){
  // zone: 121 or 119
  const lon0 = zone === 119 ? 119 : 121;  // 中央經線
  const lambda0 = rad(lon0);

  const phi = rad(latDeg);
  const lambda = rad(lonDeg);

  const ep2 = e2 / (1 - e2); // second ecc^2
  const sinp = Math.sin(phi), cosp = Math.cos(phi), tanp = Math.tan(phi);

  const N = a / Math.sqrt(1 - e2 * sinp*sinp);
  const T = tanp * tanp;
  const C = ep2 * cosp * cosp;
  const A = (lambda - lambda0) * cosp;

  const M = meridionalArc(phi);

  // 系列展開（Snyder）
  const x = FE + k0 * N * (A + (1 - T + C)*Math.pow(A,3)/6 + (5 - 18*T + T*T + 72*C - 58*ep2)*Math.pow(A,5)/120);
  const y = FN + k0 * ( M + N*tanp * ( Math.pow(A,2)/2 + (5 - T + 9*C + 4*C*C)*Math.pow(A,4)/24
                        + (61 - 58*T + T*T + 600*C - 330*ep2)*Math.pow(A,6)/720 ) );

  return { x, y };
}

/** ======= UI 邏輯 ======= */
const modeDMSBtn = document.getElementById('mode-dms');
const modeDecBtn = document.getElementById('mode-dec');
const dmsBlock = document.getElementById('dms-block');
const decBlock = document.getElementById('dec-block');
const msg = document.getElementById('msg');

let mode = 'dms';
modeDMSBtn.onclick = () => { mode='dms'; dmsBlock.style.display='block'; decBlock.style.display='none';
  modeDMSBtn.classList.add('warn'); modeDecBtn.classList.remove('warn'); status('切換為 DMS 模式'); }
modeDecBtn.onclick = () => { mode='dec'; dmsBlock.style.display='none'; decBlock.style.display='block';
  modeDecBtn.classList.add('warn'); modeDMSBtn.classList.remove('warn'); status('切換為十進位模式'); }

function status(text, ok=true){
  msg.innerHTML = `狀態：<span class="${ok?'ok':'err'}">${text}</span>`;
}

/** 執行轉換 */
document.getElementById('btn-run').onclick = () => {
  const zone = parseInt(document.getElementById('zone').value, 10);

  let lat, lon;
  if(mode === 'dms'){
    const ld = document.getElementById('lat-d').value;
    const lm = document.getElementById('lat-m').value;
    const ls = document.getElementById('lat-s').value;
    const pd = document.getElementById('lon-d').value;
    const pm = document.getElementById('lon-m').value;
    const ps = document.getElementById('lon-s').value;

    // 基本檢查
    if(ld==='' || pd===''){ return status('請至少輸入「度」欄位（緯、經）', false); }
    lat = dmsToDecimal(ld, lm, ls);
    lon = dmsToDecimal(pd, pm, ps);
  }else{
    const latDec = document.getElementById('lat-dec').value;
    const lonDec = document.getElementById('lon-dec').value;
    if(latDec==='' || lonDec===''){ return status('請輸入十進位緯度與經度', false); }
    lat = parseFloat(latDec); lon = parseFloat(lonDec);
  }

  // 合理性檢查（台灣附近）
  if(!(lat > 18 && lat < 30 && lon > 110 && lon < 130)){
    status('警告：輸入似乎不在台灣附近，仍嘗試轉換。', false);
  }else{
    status('輸入 OK，開始轉換…', true);
  }

  const {x, y} = ll2twd97(lat, lon, zone);
  document.getElementById('out-x').value = x.toFixed(3);
  document.getElementById('out-y').value = y.toFixed(3);
  status('完成 ✅');
};

/** Taipei 101 範例（N25°02′02.27″, E121°33′52.08″ ≈ 25.033964, 121.564468） */
document.getElementById('btn-fill-tpe101').onclick = () => {
  if(mode==='dms'){
    document.getElementById('lat-d').value = 25;
    document.getElementById('lat-m').value = 2;
    document.getElementById('lat-s').value = 2.27;
    document.getElementById('lon-d').value = 121;
    document.getElementById('lon-m').value = 33;
    document.getElementById('lon-s').value = 52.08;
  }else{
    document.getElementById('lat-dec').value = 25.033964;
    document.getElementById('lon-dec').value = 121.564468;
  }
  status('已填入 Taipei 101 範例座標');
};

document.getElementById('btn-clear').onclick = () => {
  ['lat-d','lat-m','lat-s','lon-d','lon-m','lon-s','lat-dec','lon-dec'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.value = '';
  });
  document.getElementById('out-x').value = '';
  document.getElementById('out-y').value = '';
  status('欄位已清空');
};
</script>
</body>
</html>
